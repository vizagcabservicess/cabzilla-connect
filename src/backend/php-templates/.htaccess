
# Enable URL rewriting
RewriteEngine On

# Set the base directory
RewriteBase /api/

# Handle OPTIONS requests for CORS preflight - immediately return 200
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule .* - [R=200,L]

# CRITICAL: Don't apply rewriting to actual files or directories
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# IMPORTANT: Redirect all /admin/* requests to the frontend
# This prevents admin API routes from intercepting frontend routes
RewriteRule ^admin/?$ /index.html [L]
RewriteRule ^admin/(.*)$ /index.html [L]

# Handle the root admin path for dashboard access
RewriteRule ^api/admin$ /api/admin/status.php [L]
RewriteRule ^api/admin/$ /api/admin/status.php [L]

# HIGHEST PRIORITY: Direct vehicle operations
# Map vehicle update endpoints to our direct-vehicle-modify.php
RewriteRule ^api/admin/vehicle-update\.php$ /api/admin/direct-vehicle-modify.php [L]
RewriteRule ^api/admin/update-vehicle\.php$ /api/admin/direct-vehicle-modify.php [L]
RewriteRule ^api/admin/vehicles-update\.php$ /api/admin/direct-vehicle-modify.php [L]
RewriteRule ^api/admin/direct-vehicle-update\.php$ /api/admin/direct-vehicle-modify.php [L]

# Map vehicle create endpoints to our direct-vehicle-create.php
RewriteRule ^api/admin/vehicle-create\.php$ /api/admin/direct-vehicle-create.php [L]
RewriteRule ^api/admin/add-vehicle\.php$ /api/admin/direct-vehicle-create.php [L]

# Map vehicle delete endpoints to our direct-vehicle-delete.php
RewriteRule ^api/admin/delete-vehicle\.php$ /api/admin/direct-vehicle-delete.php [L]
RewriteRule ^api/admin/vehicle-delete\.php$ /api/admin/direct-vehicle-delete.php [L]

# Set PHP settings for this directory
<IfModule mod_php7.c>
    php_value max_execution_time 120
    php_value memory_limit 256M
    php_value post_max_size 16M
    php_value upload_max_filesize 8M
    php_value mysql.connect_timeout 60
    php_value default_socket_timeout 60
</IfModule>

# Set PHP settings for PHP 8+
<IfModule mod_php.c>
    php_value max_execution_time 120
    php_value memory_limit 256M
    php_value post_max_size 16M
    php_value upload_max_filesize 8M
    php_value default_socket_timeout 60
</IfModule>

# Prevent direct access to sensitive files
<FilesMatch "^(config\.php|database\.sql|\.env)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Handle errors
ErrorDocument 404 /api/error.php
ErrorDocument 500 /api/error.php
