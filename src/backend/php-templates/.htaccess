
# Enable URL rewriting
RewriteEngine On

# Set the base directory
RewriteBase /

# Handle OPTIONS requests for CORS preflight - immediately return 200
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule .* - [R=200,L]

# Set aggressive CORS headers for all responses
<IfModule mod_headers.c>
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-Force-Refresh, X-Admin-Mode, X-Debug, X-Database-First, *"
    Header always set Access-Control-Max-Age "86400"
    Header always set Access-Control-Expose-Headers "*"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Cache-Control "no-cache, no-store, must-revalidate"
    Header always set Pragma "no-cache"
    Header always set Expires "0"
</IfModule>

# CRITICAL: Enable direct access to PHP files in the admin directory
<FilesMatch "\.(php)$">
    # Ensure proper PHP handling
    SetHandler application/x-httpd-php
    # For API responses
    Header always set Content-Type "application/json" env=!no_content_type
    # No caching
    Header set Cache-Control "no-cache, no-store, must-revalidate"
</FilesMatch>

# Direct access to all PHP files - CRITICAL NEW RULE
<Files ~ "\.php$">
    Order Allow,Deny
    Allow from all
    SetHandler application/x-httpd-php
</Files>

# SPECIAL RULES FOR PDF FILES - Critical for proper PDF downloads
<FilesMatch "\.(pdf)$">
    ForceType application/pdf
    Header set Content-Type application/pdf
    Header set Content-Disposition attachment
    Header set X-Content-Type-Options "nosniff"
    Header set Cache-Control "must-revalidate"
</FilesMatch>

# SPECIAL RULE FOR INVOICE DOWNLOAD - Override Content-Type for this file only
<FilesMatch "download-invoice\.php$">
    # Don't set Content-Type here, let the script handle it
    SetEnv no_content_type 1
    Header unset Content-Type env=no_content_type
    SetHandler application/x-httpd-php
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "*"
    # FIXED: Set PHP flag to disable output buffering
    php_flag output_buffering off
</FilesMatch>

# PDF Download Fix - CRITICAL - Address the PDF download issue
<Files "download-invoice.php">
    # Allow the script to set its own content type
    SetEnvIf Request_URI "download-invoice" no_content_type=1
    Header always unset Content-Type env=no_content_type
    Header always set X-Content-Type-Options "nosniff" env=no_content_type
    # FIXED: Remove any conflicting handlers
    RemoveHandler .php
    RemoveType application/x-httpd-php
    # FIXED: Ensure PHP processing still works
    SetHandler application/x-httpd-php
</Files>

# Force proper MIME type for PHP files to ensure they're executed correctly
AddType application/x-httpd-php .php
AddType application/pdf .pdf

# Disable output buffering for PDF files
<FilesMatch "\.(pdf)$">
    php_flag output_buffering Off
</FilesMatch>

# Handle PHP errors
ErrorDocument 500 "PDF Generation Error. Please check the error logs."

# Enable CORS
Header set Access-Control-Allow-Origin "*"
Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
