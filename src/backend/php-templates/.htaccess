
# Enable rewrite engine
RewriteEngine On

# Set default PHP handler - critical for proper execution
AddHandler application/x-httpd-php .php

# Ensure PHP files are processed as PHP regardless of URL structure
<FilesMatch "\.php$">
    SetHandler application/x-httpd-php
</FilesMatch>

# CORS headers for all requests
<IfModule mod_headers.c>
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Max-Age "3600"
    
    # Prevent caching for API responses
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header set Pragma "no-cache"
    Header set Expires "0"
</IfModule>

# Handle OPTIONS requests for CORS preflight
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# Ensure API requests go directly to PHP files, not React frontend
# CRITICAL FIX: All API routes must be properly handled

# Basic API endpoints
RewriteRule ^api/signup$ api/signup.php [QSA,L]
RewriteRule ^api/login$ api/login.php [QSA,L]

# User dashboard endpoints - multiple formats
RewriteRule ^api/user/dashboard$ api/user/dashboard.php [QSA,L]
RewriteRule ^api/user/dashboard/$ api/user/dashboard.php [QSA,L]

# Booking creation endpoints - multiple formats
RewriteRule ^api/book$ api/book.php [QSA,L]
RewriteRule ^api/book/$ api/book.php [QSA,L]
RewriteRule ^api/booking$ api/book.php [QSA,L]
RewriteRule ^api/booking/$ api/book.php [QSA,L]
RewriteRule ^api/booking/create$ api/book.php [QSA,L]

# CRITICAL FIX: Booking edit endpoints - multiple formats
RewriteRule ^api/booking/([0-9]+)/edit/?$ api/booking/edit.php?id=$1 [QSA,L]
RewriteRule ^api/booking/edit/([0-9]+)/?$ api/booking/edit.php?id=$1 [QSA,L]
RewriteRule ^api/book/edit/([0-9]+)/?$ api/booking/edit.php?id=$1 [QSA,L]
RewriteRule ^api/edit/booking/([0-9]+)/?$ api/booking/edit.php?id=$1 [QSA,L]

# CRITICAL FIX: Receipt endpoints - multiple formats
RewriteRule ^api/receipt/([0-9]+)/?$ api/receipt.php?id=$1 [QSA,L]
RewriteRule ^api/booking/([0-9]+)/receipt/?$ api/receipt.php?id=$1 [QSA,L]
RewriteRule ^api/booking/receipt/([0-9]+)/?$ api/receipt.php?id=$1 [QSA,L]
RewriteRule ^api/booking/([0-9]+)/?$ api/receipt.php?id=$1 [QSA,L]

# CRITICAL FIX: Cancel endpoints - multiple formats
RewriteRule ^api/booking/cancel$ api/booking/cancel.php [QSA,L]
RewriteRule ^api/booking/([0-9]+)/cancel/?$ api/booking/cancel.php?id=$1 [QSA,L]
RewriteRule ^api/booking/cancel/([0-9]+)/?$ api/booking/cancel.php?id=$1 [QSA,L]
RewriteRule ^api/book/cancel/([0-9]+)/?$ api/booking/cancel.php?id=$1 [QSA,L]

# Admin endpoints
RewriteRule ^api/admin/bookings$ api/admin/bookings.php [QSA,L]
RewriteRule ^api/fares/tours$ api/fares/tours.php [QSA,L]
RewriteRule ^api/fares/vehicles$ api/fares/vehicles.php [QSA,L]
RewriteRule ^api/admin/fares/update$ api/admin/fares-update.php [QSA,L]
RewriteRule ^api/admin/km-price/update$ api/admin/km-price-update.php [QSA,L]

# Direct access to PHP files - highest priority
RewriteCond %{REQUEST_URI} \.php$
RewriteRule ^(.*)$ $1 [L]

# Fallback for all other API paths to maintain compatibility
RewriteCond %{REQUEST_URI} ^/api/
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/(.*)$ api/$1.php [QSA,L]

# Redirect all non-file/directory/API requests to index.html for React Router
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteRule ^ index.html [QSA,L]
