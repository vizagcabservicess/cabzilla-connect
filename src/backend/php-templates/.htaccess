
# Enable rewrite engine
RewriteEngine On
RewriteBase /

# Handle OPTIONS requests for CORS preflight
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule .* - [R=200,L]

# Set CORS headers for all responses
Header always set Access-Control-Allow-Origin "*"
Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-Admin-Mode, X-Debug"

# CRITICAL: Special handling for invoice endpoints - NO content type header
<Files ~ "(download-invoice|generate-invoice)\.php$">
    SetEnv no_content_type 1
    Header unset Content-Type env=no_content_type
    SetHandler application/x-httpd-php
</Files>

# Handle all PHP files except invoices
<FilesMatch "\.php$">
    SetHandler application/x-httpd-php
    SetEnv no_content_type 0
    Header set Content-Type "application/json" env=!no_content_type
</FilesMatch>

# Critical API endpoints that need direct access
RewriteRule ^api/admin/download-invoice/?$ api/admin/download-invoice.php [L,QSA]
RewriteRule ^api/download-invoice/?$ api/download-invoice.php [L,QSA]
RewriteRule ^api/admin/generate-invoice/?$ api/admin/generate-invoice.php [L,QSA]

# Ensure PHP files are executed
<Files ~ "\.php$">
    Order Allow,Deny
    Allow from all
</Files>

