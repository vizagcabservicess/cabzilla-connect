
# Enable URL rewriting
RewriteEngine On

# Set the base directory
RewriteBase /api/

# CRITICAL: Respond with 200 OK for OPTIONS preflight requests (highest priority)
# This must be the very first rule for CORS to work properly
<IfModule mod_headers.c>
    <If "%{REQUEST_METHOD} == 'OPTIONS'">
        Header always set Status "200 OK"
        Header always set Access-Control-Allow-Origin "*" 
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-Force-Refresh, X-Admin-Mode, *"
        Header always set Access-Control-Max-Age "86400"
        Header always set Content-Type "text/plain"
        Header always set Content-Length "0"
    </If>
</IfModule>

# Set access headers for all responses with high priority
<IfModule mod_headers.c>
    # Set CORS headers unconditionally for all responses - high priority
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "*"
    Header always set Access-Control-Max-Age "86400"
    Header always set Access-Control-Expose-Headers "*"
    
    # Debug headers to help troubleshoot CORS issues
    Header always set X-CORS-Debug "CORS headers set by API htaccess"
    Header always set X-API-Version "1.2.1"
    Header always set X-Server-Time "%{TIME}e"
    Header always set X-Request-ID "%{UNIQUE_ID}e"
</IfModule>

# Handle OPTIONS requests for CORS preflight - immediately return 200
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule .* - [R=200,L]

# VEHICLE DELETE OPERATIONS - HIGHEST PRIORITY
# Critical: Make sure delete-vehicle.php is mapped correctly with highest priority
RewriteRule ^delete-vehicle$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^delete-vehicle\.php$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^admin/delete-vehicle$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^admin/delete-vehicle\.php$ admin/direct-vehicle-delete.php [L,QSA]

# Critical: Map vehicle-delete.php to direct-vehicle-delete.php
RewriteRule ^vehicle-delete$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^vehicle-delete\.php$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^admin/vehicle-delete$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^admin/vehicle-delete\.php$ admin/direct-vehicle-delete.php [L,QSA]

# DIRECT VEHICLE OPERATIONS - HIGHEST PRIORITY
# Critical: Make sure add-vehicle.php is mapped correctly with highest priority
RewriteRule ^add-vehicle$ admin/direct-vehicle-create.php [L,QSA]
RewriteRule ^add-vehicle\.php$ admin/direct-vehicle-create.php [L,QSA]
RewriteRule ^admin/add-vehicle$ admin/direct-vehicle-create.php [L,QSA]
RewriteRule ^admin/add-vehicle\.php$ admin/direct-vehicle-create.php [L,QSA]

# Critical: Make sure update-vehicle.php is mapped correctly with highest priority
RewriteRule ^update-vehicle$ admin/direct-vehicle-modify.php [L,QSA]
RewriteRule ^update-vehicle\.php$ admin/direct-vehicle-modify.php [L,QSA]
RewriteRule ^admin/update-vehicle$ admin/direct-vehicle-modify.php [L,QSA]
RewriteRule ^admin/update-vehicle\.php$ admin/direct-vehicle-modify.php [L,QSA]

# Critical: Make sure direct-vehicle-delete.php is mapped correctly
RewriteRule ^direct-vehicle-delete$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^direct-vehicle-delete\.php$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^admin/direct-vehicle-delete$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^admin/direct-vehicle-delete\.php$ admin/direct-vehicle-delete.php [L,QSA]

# Critical: Make sure vehicle-update.php is mapped correctly with highest priority
RewriteRule ^vehicle-update$ admin/direct-vehicle-modify.php [L,QSA]
RewriteRule ^vehicle-update\.php$ admin/direct-vehicle-modify.php [L,QSA]
RewriteRule ^admin/vehicle-update$ admin/direct-vehicle-modify.php [L,QSA]
RewriteRule ^admin/vehicle-update\.php$ admin/direct-vehicle-modify.php [L,QSA]

# Don't apply rewriting to actual files or directories
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Map vehicle update endpoints to our direct-vehicle-modify.php
RewriteRule ^admin/update-vehicle\.php$ /api/admin/direct-vehicle-modify.php [L]
RewriteRule ^admin/vehicle-update\.php$ /api/admin/direct-vehicle-modify.php [L]
RewriteRule ^admin/vehicles-update\.php$ /api/admin/direct-vehicle-modify.php [L]
RewriteRule ^admin/direct-vehicle-update\.php$ /api/admin/direct-vehicle-modify.php [L]

# Map vehicle delete endpoints to our direct-vehicle-delete.php
RewriteRule ^admin/delete-vehicle\.php$ /api/admin/direct-vehicle-delete.php [L]
RewriteRule ^admin/vehicle-delete\.php$ /api/admin/direct-vehicle-delete.php [L]

# Fix for adding CONTENT_TYPE to server variables
SetEnvIf Content-Type "(.*)" CONTENT_TYPE=$1

# Set PHP settings for this directory
<IfModule mod_php7.c>
    php_value max_execution_time 120
    php_value memory_limit 256M
    php_value post_max_size 16M
    php_value upload_max_filesize 8M
    php_value mysql.connect_timeout 60
    php_value default_socket_timeout 60
</IfModule>

# Set PHP settings for PHP 8+
<IfModule mod_php.c>
    php_value max_execution_time 120
    php_value memory_limit 256M
    php_value post_max_size 16M
    php_value upload_max_filesize 8M
    php_value default_socket_timeout 60
</IfModule>

# Prevent direct access to sensitive files
<FilesMatch "^(config\.php|database\.sql|\.env)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Handle errors
ErrorDocument 404 /api/error.php
ErrorDocument 500 /api/error.php
