# Enable URL rewriting with aggressive CORS configuration
RewriteEngine On
RewriteBase /api/

# CRITICAL: Force PHP processing for all .php files - MUST BE FIRST!
<FilesMatch "\.php$">
    # Ensure PHP files are processed correctly
    SetHandler application/x-httpd-php
    # Set JSON content type for API responses
    Header always set Content-Type "application/json" env=!no_content_type
    # No caching for PHP files
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
</FilesMatch>

# SPECIAL PDF FILES - CRITICAL for proper PDF handling
<FilesMatch "\.(pdf)$">
    ForceType application/pdf
    Header always set Content-Type application/pdf
    Header always set Content-Disposition attachment
    Header always set X-Content-Type-Options "nosniff"
</FilesMatch>

# CRITICAL: Special handling for download-invoice.php
<Files "download-invoice.php">
    # Critical - Don't set Content-Type here, let the script handle it
    SetEnv no_content_type 1
    SetHandler application/x-httpd-php
    Header always unset Content-Type
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header always set Access-Control-Allow-Headers "*"
    # Ensure no caching for PDF files
    Header always set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header always set Pragma "no-cache"
    Header always set Expires "0"
</Files>

# CRITICAL: Respond with 200 OK for OPTIONS preflight requests (highest priority)
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule .* - [R=200,L]

# Set access headers for all responses
<IfModule mod_headers.c>
    # Set CORS headers unconditionally for all responses
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "*"
    Header always set Access-Control-Max-Age "86400"
    Header always set Access-Control-Expose-Headers "*"
    Header always set X-Content-Type-Options "nosniff"
</IfModule>

# EXPLICITLY SET PDF MIME TYPE for PDFs - Critical fix
<FilesMatch "\.pdf$">
    ForceType application/pdf
    Header always set Content-Type application/pdf
    Header always set X-Content-Type-Options "nosniff"
</FilesMatch>

# CRITICAL: Fix schema endpoints - must come first
RewriteRule ^admin/fix-schema$ admin/fix-schema.php [L,QSA]
RewriteRule ^admin/fix-schema\.php$ admin/fix-schema.php [L,QSA]
RewriteRule ^fix-schema$ admin/fix-schema.php [L,QSA]
RewriteRule ^fix-schema\.php$ admin/fix-schema.php [L,QSA]
RewriteRule ^admin/fix-drivers-schema$ admin/fix-drivers-schema.php [L,QSA]
RewriteRule ^admin/fix-drivers-schema\.php$ admin/fix-drivers-schema.php [L,QSA]
RewriteRule ^fix-drivers-schema$ admin/fix-drivers-schema.php [L,QSA]
RewriteRule ^fix-drivers-schema\.php$ admin/fix-drivers-schema.php [L,QSA]
RewriteRule ^admin/fix-drivers-table$ admin/fix-drivers-table.php [L,QSA]
RewriteRule ^admin/fix-drivers-table\.php$ admin/fix-drivers-table.php [L,QSA]

# Direct access to admin endpoints - highest priority
RewriteRule ^admin/users$ admin/users.php [L,QSA]
RewriteRule ^admin/users\.php$ admin/users.php [L,QSA]
RewriteRule ^admin/direct-user-data$ admin/direct-user-data.php [L,QSA]
RewriteRule ^admin/direct-user-data\.php$ admin/direct-user-data.php [L,QSA]

# Critical invoice endpoints - highest priority
RewriteRule ^admin/generate-invoice$ admin/generate-invoice.php [L,QSA]
RewriteRule ^admin/generate-invoice\.php$ admin/generate-invoice.php [L,QSA]
RewriteRule ^admin/download-invoice$ admin/download-invoice.php [L,QSA]
RewriteRule ^admin/download-invoice\.php$ admin/download-invoice.php [L,QSA]
# Public invoice endpoints
RewriteRule ^download-invoice$ download-invoice.php [L,QSA]
RewriteRule ^download-invoice\.php$ download-invoice.php [L,QSA]

# Diagnostic endpoints - highest priority
RewriteRule ^test-connection$ test-connection.php [L,QSA]
RewriteRule ^test-booking-api$ admin/test-booking-api.php [L,QSA]
RewriteRule ^direct-connection$ test-connection.php [L,QSA]

# ADD: Test email endpoints - high priority with multiple URLs
RewriteRule ^test-email-sending$ test-email-sending.php [L,QSA]
RewriteRule ^test-email-sending\.php$ test-email-sending.php [L,QSA]
RewriteRule ^test-email$ test-email-sending.php [L,QSA]

# HIGHEST PRIORITY: Booking endpoints
RewriteRule ^book$ book.php [L,QSA]
RewriteRule ^book\.php$ book.php [L,QSA]
RewriteRule ^book/$ book.php [L,QSA]
RewriteRule ^create-booking$ book.php [L,QSA]
RewriteRule ^create-booking\.php$ book.php [L,QSA]

# HIGHEST PRIORITY: Email confirmation endpoints
RewriteRule ^send-booking-confirmation$ send-booking-confirmation.php [L,QSA]
RewriteRule ^send-booking-confirmation\.php$ send-booking-confirmation.php [L,QSA]
RewriteRule ^email-confirmation$ send-booking-confirmation.php [L,QSA]

# CRITICAL: Force direct PHP for critical files - ensure JSON content type
<Files "book.php">
    SetHandler application/x-httpd-php
    Header always set Content-Type "application/json"
</Files>
<Files "test-connection.php">
    SetHandler application/x-httpd-php
    Header always set Content-Type "application/json"
</Files>
<Files "send-booking-confirmation.php">
    SetHandler application/x-httpd-php
    Header always set Content-Type "application/json"
</Files>
<Files "test-email-sending.php">
    SetHandler application/x-httpd-php
    Header always set Content-Type "application/json"
</Files>

# SPECIAL HANDLING FOR INVOICE AND RECEIPT ENDPOINTS
RewriteRule ^admin/invoice/([0-9]+)/?$ admin/generate-invoice.php?id=$1 [L,NC,QSA] 
RewriteRule ^invoice/([0-9]+)/?$ admin/generate-invoice.php?id=$1 [L,NC,QSA]
RewriteRule ^admin/receipt/([0-9]+)/?$ admin/receipt.php?id=$1 [L,NC,QSA]
RewriteRule ^receipt/([0-9]+)/?$ admin/receipt.php?id=$1 [L,NC,QSA]

# CRITICAL BOOKING API ENDPOINTS
RewriteRule ^admin/assign-driver/?$ admin/assign-driver.php [L,NC,QSA]
RewriteRule ^admin/cancel-booking/?$ admin/cancel-booking.php [L,NC,QSA]
RewriteRule ^admin/update-booking/?$ admin/update-booking.php [L,NC,QSA]

# Force MIME types
AddType application/pdf .pdf
AddType application/x-httpd-php .php
