# Enable rewrite engine
RewriteEngine On

# CRITICAL: Respond with 200 OK for OPTIONS preflight requests (highest priority)
# This must be the very first rule for CORS to work properly
<IfModule mod_headers.c>
    <If "%{REQUEST_METHOD} == 'OPTIONS'">
        Header always set Status "200 OK"
        Header always set Access-Control-Allow-Origin "*" 
        Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header always set Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization, X-Force-Refresh, X-Admin-Mode, X-Debug, *"
        Header always set Access-Control-Max-Age "86400"
        Header always set Content-Type "text/plain"
        Header always set Content-Length "0"
    </If>
</IfModule>

# Set access headers for all responses with high priority
<IfModule mod_headers.c>
    # Set CORS headers unconditionally for all responses - high priority
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "*"
    Header always set Access-Control-Max-Age "86400"
    Header always set Access-Control-Expose-Headers "*"
</IfModule>

# Handle OPTIONS requests for CORS preflight - immediately return 200
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule .* - [R=200,L]

# CRITICAL: Vehicle validation endpoint has highest priority
RewriteRule ^check-vehicle$ admin/check-vehicle.php [L,QSA]
RewriteRule ^check-vehicle\.php$ admin/check-vehicle.php [L,QSA]
RewriteRule ^admin/check-vehicle$ admin/check-vehicle.php [L,QSA]
RewriteRule ^admin/check-vehicle\.php$ admin/check-vehicle.php [L,QSA]

# CRITICAL VEHICLE ENDPOINTS - HIGHEST PRIORITY
# Direct vehicle update endpoint
RewriteRule ^direct-vehicle-update$ admin/direct-vehicle-update.php [L,QSA]
RewriteRule ^direct-vehicle-update\.php$ admin/direct-vehicle-update.php [L,QSA]
RewriteRule ^admin/direct-vehicle-update$ admin/direct-vehicle-update.php [L,QSA]
RewriteRule ^admin/direct-vehicle-update\.php$ admin/direct-vehicle-update.php [L,QSA]

# Direct vehicle create endpoint
RewriteRule ^direct-vehicle-create$ admin/direct-vehicle-create.php [L,QSA]
RewriteRule ^direct-vehicle-create\.php$ admin/direct-vehicle-create.php [L,QSA]
RewriteRule ^admin/direct-vehicle-create$ admin/direct-vehicle-create.php [L,QSA]
RewriteRule ^admin/direct-vehicle-create\.php$ admin/direct-vehicle-create.php [L,QSA]

# Direct vehicle delete endpoint
RewriteRule ^direct-vehicle-delete$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^direct-vehicle-delete\.php$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^admin/direct-vehicle-delete$ admin/direct-vehicle-delete.php [L,QSA]
RewriteRule ^admin/direct-vehicle-delete\.php$ admin/direct-vehicle-delete.php [L,QSA]

# Direct vehicle modify endpoint
RewriteRule ^direct-vehicle-modify$ admin/direct-vehicle-modify.php [L,QSA]
RewriteRule ^direct-vehicle-modify\.php$ admin/direct-vehicle-modify.php [L,QSA]
RewriteRule ^admin/direct-vehicle-modify$ admin/direct-vehicle-modify.php [L,QSA]
RewriteRule ^admin/direct-vehicle-modify\.php$ admin/direct-vehicle-modify.php [L,QSA]

# CRITICAL FARE ENDPOINTS - HIGH PRIORITY
# Local fares update endpoint with fixed priority
RewriteRule ^local-fares-update$ admin/local-fares-update.php [L,QSA]
RewriteRule ^local-fares-update\.php$ admin/local-fares-update.php [L,QSA]
RewriteRule ^admin/local-fares-update$ admin/local-fares-update.php [L,QSA]
RewriteRule ^admin/local-fares-update\.php$ admin/local-fares-update.php [L,QSA]

# Make sure sync-local-fares endpoint is accessible from multiple paths
RewriteRule ^sync-local-fares$ admin/sync-local-fares.php [L,QSA]
RewriteRule ^sync-local-fares\.php$ admin/sync-local-fares.php [L,QSA]
RewriteRule ^admin/sync-local-fares$ admin/sync-local-fares.php [L,QSA]
RewriteRule ^admin/sync-local-fares\.php$ admin/sync-local-fares.php [L,QSA]

# Direct fare-related endpoints for all trip types - highest priority
RewriteRule ^direct-local-fares$ admin/direct-local-fares.php [L,QSA]
RewriteRule ^direct-local-fares\.php$ admin/direct-local-fares.php [L,QSA]
RewriteRule ^admin/direct-local-fares$ admin/direct-local-fares.php [L,QSA]
RewriteRule ^admin/direct-local-fares\.php$ admin/direct-local-fares.php [L,QSA]

# Direct outstation fares endpoints - highest priority
RewriteRule ^direct-outstation-fares$ admin/direct-outstation-fares.php [L,QSA]
RewriteRule ^direct-outstation-fares\.php$ admin/direct-outstation-fares.php [L,QSA]
RewriteRule ^admin/direct-outstation-fares$ admin/direct-outstation-fares.php [L,QSA]
RewriteRule ^admin/direct-outstation-fares\.php$ admin/direct-outstation-fares.php [L,QSA]

# Direct airport fares endpoints - highest priority
RewriteRule ^direct-airport-fares$ admin/direct-airport-fares.php [L,QSA]
RewriteRule ^direct-airport-fares\.php$ admin/direct-airport-fares.php [L,QSA]
RewriteRule ^admin/direct-airport-fares$ admin/direct-airport-fares.php [L,QSA]
RewriteRule ^admin/direct-airport-fares\.php$ admin/direct-airport-fares.php [L,QSA]

# Vehicle data endpoint with high priority
RewriteRule ^vehicles-data$ vehicles-data.php [L,QSA]
RewriteRule ^vehicles-data\.php$ vehicles-data.php [L,QSA]
RewriteRule ^admin/vehicles-data$ vehicles-data.php [L,QSA]
RewriteRule ^admin/vehicles-data\.php$ vehicles-data.php [L,QSA]

# Legacy/fallback endpoints - lower priority
# ... keep existing code (Legacy endpoint mappings and general API endpoints)

# Debug headers to help troubleshoot routing
Header set X-Requested-Path "%{REQUEST_URI}e"
Header set X-Query-String "%{QUERY_STRING}e"
Header set X-Script-Filename "%{SCRIPT_FILENAME}e"

# Protect PHP files from direct access
<Files "*.php">
    # Allow all requests through - critical for CORS
    Require all granted
</Files>

# Prevent directory listing
Options -Indexes
